(配置文件修改路径:

- ```/home/opt/f_deploy/api_java/roles/deploy/templates```
-     ```/home/opt/f_deploy/discover/roles/deploy/templates/discover```)

1.discover项目的配置文件添加

```
北美站的discover 的 application.properties中:

kafka.hot_deal.topics这个键的值在最后添加上biz.hot_deal.home_view

kafka.hot_deal.othersites.topics=uk.hot_deal.home_view,uk.hot_deal.deal_view,uk.hot_deal.deal_share,uk.hot_deal.deal_fav,uk.hot_deal.deal_comment,uk.hot_deal.deal_click,au.hot_deal.home_view,au.hot_deal.deal_view,au.hot_deal.deal_share,au.hot_deal.deal_fav,au.hot_deal.deal_comment,au.hot_deal.deal_click,ca.hot_deal.home_view,ca.hot_deal.deal_view,ca.hot_deal.deal_share,ca.hot_deal.deal_fav,ca.hot_deal.deal_comment,ca.hot_deal.deal_click

其他三个站的discover 的 application.xml中添加:
kafka.hot_deal.othersites.topics=

四个站的discover-biz.xml中添加:

        <map>
            <entry key="name" value="discover_othersites"/>
            <entry key="bootstrap.servers" value="${usa.kafka.server}"/>
            <entry key="group.id" value="${kafka.group}"/>
            <!--<entry key="session.timeout.ms" value="${kafka.discover.deal.timeout}"/>-->
            <!--<entry key="key.deserializer" value="${kafka.discover.deal.key.deserializer}"/>-->
            <!--<entry key="value.deserializer" value="${kafka.discover.deal.value.deserializer}"/>-->
            <entry key="topics" value="${kafka.hot_deal.othersites.topics}"/>
        </map>
```

2.API_java的APP项目  logback.xml添加

```
  <appender name="SEARCH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
    <destination>生产环境logstash的ip:4560</destination>
    <reconnectionDelay>1 second</reconnectionDelay>
    <encoder class="net.logstash.logback.encoder.LogstashEncoder" />
  </appender>

  <logger level="INFO" name="deal-metric" additivity="false">
    <appender-ref ref="SEARCH" />
  </logger>
```
3.更新模板

```
curl -H "Content-Type: application/json" -X PUT -d '
{
    "template": "dealmoon_user_behavior_*",
    "settings": {
      "index": {
        "number_of_shards": "1"
      }
    },
    "mappings": {
      "behavior": {
        "dynamic": "false",
        "_all": {
          "term_vector": "no"
        },
        "properties": {
          "resType": {
            "type": "integer"
          },
          "ip": {
            "type": "ip"
          },
          "gctype": {
            "type": "integer"
          },
          "owners": {
            "type": "nested",
            "properties": {
              "id": {
                "type": "text"
              },
              "type": {
                "type": "integer"
              }
            }
          },
          "state": {
            "type": "integer"
          },
          "time": {
            "type": "date"
          },
          "behavior": {
            "type": "integer"
          },
          "udid": {
            "type": "text",
            "fields": {
              "raw": {
                "type": "keyword"
              }
            }
          },
          "resId": {
            "type": "integer"
          },
          "userId": {
            "type": "integer"
          },
          "platform": {
            "type": "integer"
          },
          "site":{
              "type":"integer"
          }
        }
      }
    },
    "aliases": {}
}
' http://127.0.0.1:9210/_template/dealmoon_user_behavior
```

修改3月的mapping

```
curl -H "Content-Type: application/json" -X PUT -d '
{
        "dynamic": "false",
        "_all": {
          "term_vector": "no"
        },
        "properties": {
          "resType": {
            "type": "integer"
          },
          "ip": {
            "type": "ip"
          },
          "gctype": {
            "type": "integer"
          },
          "owners": {
            "type": "nested",
            "properties": {
              "id": {
                "type": "text"
              },
              "type": {
                "type": "integer"
              }
            }
          },
          "state": {
            "type": "integer"
          },
          "time": {
            "type": "date"
          },
          "behavior": {
            "type": "integer"
          },
          "udid": {
            "type": "text",
            "fields": {
              "raw": {
                "type": "keyword"
              }
            }
          },
          "resId": {
            "type": "integer"
          },
          "userId": {
            "type": "integer"
          },
          "platform": {
            "type": "integer"
          },
          "site":{
              "type":"integer"
          }
    }
}
' http://127.0.0.1:9210/dealmoon_user_behavior_201804/behavior/_mapping
```



```
{"appid":"java_api","name":"home_view","time":"1522221580","class":"uk.hot_deal","value":{"userId":"853355","dealId":"754390","ip":"","udid":"865738039962948","platform":"Android","country":"US","fromPage":"deal_detail","fromObj":"","itemId":"","lang":"ch","version":"0.0.1","data":{}}}
```

